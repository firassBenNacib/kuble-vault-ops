name: K8s Manifests Security

on:
  push:
    branches: [ main, pipeline ]
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '!.github/**'
      - '.github/workflows/k8s-manifest-security.yaml'
  pull_request:
    branches: [ main, pipeline ]
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '!.github/**'
      - '.github/workflows/k8s-manifest-security.yaml'

env:
  MANIFEST_DIR: .
  TRIVY_VERSION: '0.68.1'
  KUBE_SCORE_VERSION: '1.18.0'
  VAULT_VERSION: '1.18.4'

jobs:
  k8s-manifest-security:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ github.run_id }}
          restore-keys: |
            trivy-db-

      - name: Cache downloaded tools
        uses: actions/cache@v4
        with:
          path: |
            /tmp/vault-cli
            ~/.local/bin
          key: security-tools-${{ env.VAULT_VERSION }}-${{ env.KUBE_SCORE_VERSION }}
          restore-keys: |
            security-tools-

      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@v0.2.4
        with:
          version: v${{ env.TRIVY_VERSION }}

      - name: Trivy secret scan
        id: trivy_secrets
        run: |
          trivy fs \
            --scanners secret \
            --skip-dirs .git --skip-dirs .github \
            --format sarif \
            --output trivy-secrets.sarif \
            --severity CRITICAL,HIGH,MEDIUM \
            --exit-code 1 \
            "${MANIFEST_DIR}"
        continue-on-error: false

      - name: Upload Trivy secrets SARIF artifact
        if: ${{ always() && hashFiles('trivy-secrets.sarif') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: trivy-secrets-sarif-${{ github.run_number }}
          path: trivy-secrets.sarif
          retention-days: 90

      - name: Upload Trivy secrets SARIF to code scanning
        if: ${{ always() && hashFiles('trivy-secrets.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-secrets.sarif
          category: trivy-secrets
        continue-on-error: true

      - name: Setup kubeconform
        uses: bmuschko/setup-kubeconform@v1.0.0

      - name: Run kubeconform validation
        id: kubeconform
        run: |
          kubeconform \
            -summary \
            -strict \
            -ignore-missing-schemas \
            -output json \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/{{.NormalizedKubernetesVersion}}-standalone/{{.ResourceKind}}.json' \
            -ignore-filename-pattern '(^|/)vault/roles/' \
            -ignore-filename-pattern '(^|/)vault/policies/' \
            -ignore-filename-pattern '(^|/)vault/values/' \
            -ignore-filename-pattern '(^|/)\.github/' \
            -ignore-filename-pattern 'trivy-.*\.(json|sarif)$' \
            "${MANIFEST_DIR}" | tee kubeconform-results.json
          
          INVALID=$(jq -r '.summary.invalid // 0' kubeconform-results.json)
          ERRORS=$(jq -r '.summary.errors // 0' kubeconform-results.json)
          
          if [ "$INVALID" -gt 0 ] || [ "$ERRORS" -gt 0 ]; then
            echo "::error::Found $INVALID invalid manifests and $ERRORS errors"
            exit 1
          fi
        continue-on-error: false

      - name: Upload kubeconform results
        if: ${{ always() && hashFiles('kubeconform-results.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: kubeconform-results-${{ github.run_number }}
          path: kubeconform-results.json
          retention-days: 30

      - name: Install Vault CLI
        run: |
          if [ ! -f /tmp/vault-cli/vault ]; then
            mkdir -p /tmp/vault-cli
            cd /tmp/vault-cli
            wget -q "https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip"
            wget -q "https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_SHA256SUMS" -O SHA256SUMS
            grep "vault_${VAULT_VERSION}_linux_amd64.zip" SHA256SUMS | sha256sum -c -
            unzip -o "vault_${VAULT_VERSION}_linux_amd64.zip"
          fi
          sudo cp /tmp/vault-cli/vault /usr/local/bin/vault
          vault --version

      - name: Validate Vault policies
        id: vault_policies
        run: |
          EXIT_CODE=0
          
          if [ -d vault/policies ]; then
            echo "Validating Vault HCL policies..."
            for policy in vault/policies/*.hcl; do
              if [ -f "$policy" ]; then
                echo "Checking $policy"
                
                if ! vault policy fmt "$policy"; then
                  echo "::error file=$policy::Policy formatting failed"
                  EXIT_CODE=1
                fi
                
                if grep -qi 'path ".*\*.*\*' "$policy"; then
                  echo "::warning file=$policy::Multiple wildcards detected - review for least privilege"
                fi
                
                if grep -q '"sudo"' "$policy"; then
                  echo "::warning file=$policy::Contains 'sudo' capability - ensure this is necessary"
                fi
              fi
            done
          else
            echo "::warning::No vault/policies directory found"
          fi
          
          exit $EXIT_CODE
        continue-on-error: false

      - name: Validate Vault roles
        run: |
          EXIT_CODE=0
          
          if [ -d vault/roles ]; then
            echo "Validating Vault role JSON files..."
            for role in vault/roles/*.json; do
              if [ -f "$role" ]; then
                echo "Validating $role"
                
                if ! jq empty "$role" 2>/dev/null; then
                  echo "::error file=$role::Invalid JSON syntax"
                  EXIT_CODE=1
                  continue
                fi
                
                if ! jq -e '.bound_service_account_names' "$role" >/dev/null; then
                  echo "::error file=$role::Missing bound_service_account_names"
                  EXIT_CODE=1
                fi
                
                if ! jq -e '.bound_service_account_namespaces' "$role" >/dev/null; then
                  echo "::error file=$role::Missing bound_service_account_namespaces"
                  EXIT_CODE=1
                fi
                
                TOKEN_TTL=$(jq -r '.token_ttl // "0m"' "$role" | sed 's/[a-z]//g')
                if [ "$TOKEN_TTL" -gt 60 ]; then
                  echo "::warning file=$role::token_ttl exceeds 1 hour"
                fi
              fi
            done
          fi
          
          exit $EXIT_CODE
        continue-on-error: false

      - name: Trivy misconfig scan
        id: trivy_misconfig
        run: |
          trivy fs \
            --scanners misconfig \
            --skip-dirs .git --skip-dirs .github \
            --format sarif \
            --output trivy-misconfig.sarif \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            "${MANIFEST_DIR}"
        continue-on-error: true

      - name: Upload Trivy misconfig SARIF artifact
        if: ${{ always() && hashFiles('trivy-misconfig.sarif') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: trivy-misconfig-sarif-${{ github.run_number }}
          path: trivy-misconfig.sarif
          retention-days: 90

      - name: Upload Trivy misconfig SARIF to code scanning
        if: ${{ always() && hashFiles('trivy-misconfig.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-misconfig.sarif
          category: trivy-misconfig
        continue-on-error: true

      - name: Trivy IaC config scan
        id: trivy_config
        run: |
          trivy config \
            --format sarif \
            --output trivy-config.sarif \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            "${MANIFEST_DIR}"
        continue-on-error: true

      - name: Upload Trivy config SARIF artifact
        if: ${{ always() && hashFiles('trivy-config.sarif') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: trivy-config-sarif-${{ github.run_number }}
          path: trivy-config.sarif
          retention-days: 90

      - name: Upload Trivy config SARIF to code scanning
        if: ${{ always() && hashFiles('trivy-config.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-config.sarif
          category: trivy-config
        continue-on-error: true

      - name: Kubescape scan
        id: kubescape
        uses: kubescape/github-action@v3.0.21
        continue-on-error: true
        with:
          files: "**/*.yaml"
          format: sarif
          outputFile: kubescape-results
          severityThreshold: critical
          frameworks: |
            nsa,mitre,armobest
          failedThreshold: 40

      - name: Upload Kubescape SARIF artifact
        if: ${{ always() && hashFiles('kubescape-results.sarif') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: kubescape-sarif-${{ github.run_number }}
          path: kubescape-results.sarif
          retention-days: 90

      - name: Upload Kubescape SARIF to code scanning
        if: ${{ always() && hashFiles('kubescape-results.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: kubescape-results.sarif
          category: kubescape
        continue-on-error: true

      - name: Install Checkov
        run: |
          pip3 install --upgrade pip setuptools wheel
          pip3 install checkov

      - name: Run Checkov
        id: checkov
        run: |
          checkov \
            --directory . \
            --framework kubernetes \
            --output sarif \
            --output-file-path checkov-results.sarif \
            --skip-framework dockerfile,dockerfile_lint,secrets \
            --compact \
            --quiet
        continue-on-error: true

      - name: Upload Checkov SARIF artifact
        if: ${{ always() && hashFiles('checkov-results.sarif') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: checkov-sarif-${{ github.run_number }}
          path: checkov-results.sarif
          retention-days: 90

      - name: Upload Checkov SARIF to code scanning
        if: ${{ always() && hashFiles('checkov-results.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: checkov-results.sarif
          category: checkov
        continue-on-error: true

      - name: Run kube-score
        id: kube_score
        run: |
          if [ ! -f ~/.local/bin/kube-score ]; then
            mkdir -p ~/.local/bin
            cd ~/.local/bin
            wget -q "https://github.com/zegl/kube-score/releases/download/v${KUBE_SCORE_VERSION}/checksums.txt"
            wget -q "https://github.com/zegl/kube-score/releases/download/v${KUBE_SCORE_VERSION}/kube-score_${KUBE_SCORE_VERSION}_linux_amd64"
            grep "kube-score_${KUBE_SCORE_VERSION}_linux_amd64$" checksums.txt | sha256sum -c -
            chmod +x "kube-score_${KUBE_SCORE_VERSION}_linux_amd64"
            mv "kube-score_${KUBE_SCORE_VERSION}_linux_amd64" kube-score
          fi
          
          find "${MANIFEST_DIR}" -name '*.yaml' -o -name '*.yml' | \
            grep -v '.github' | \
            grep -v 'trivy-' | \
            xargs ~/.local/bin/kube-score score --output-format ci > kube-score-report.txt || true
        continue-on-error: true

      - name: Upload kube-score report
        if: ${{ always() && hashFiles('kube-score-report.txt') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: kube-score-report-${{ github.run_number }}
          path: kube-score-report.txt
          retention-days: 30

      - name: Generate security summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          # Kubernetes Manifest Security Scan Results
          
          ## Scan Status
          
          | Scanner | Status | Severity |
          |---------|--------|----------|
          | Trivy Secrets | ${{ steps.trivy_secrets.outcome }} | Critical |
          | Kubeconform | Passed | Critical |
          | Vault Policies | ${{ steps.vault_policies.outcome }} | Critical |
          | Trivy Misconfig | ${{ steps.trivy_misconfig.outcome }} | High |
          | Trivy Config | ${{ steps.trivy_config.outcome }} | High |
          | Kubescape | ${{ steps.kubescape.outcome }} | High |
          | Checkov | ${{ steps.checkov.outcome }} | High |
          | Kube-score | ${{ steps.kube_score.outcome }} | Info |
          
          ## Generated Artifacts
          
          - SARIF files uploaded to GitHub Security tab
          - Detailed reports available in workflow artifacts
          - Security findings annotated in code
          
          ## Next Steps
          
          1. Review findings in the Security tab
          2. Check workflow artifacts for detailed reports
          3. Address critical and high severity issues
          
          ---
          Security scan completed on ${{ github.ref_name }}
          EOF

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const criticalPassed = '${{ steps.trivy_secrets.outcome }}' === 'success' && 
                                   '${{ steps.vault_policies.outcome }}' === 'success';
            const status = criticalPassed ? 'PASSED' : 'FAILED';
            
            let comment = `## Security Scan Results: ${status}\n\n`;
            comment += '### Critical Checks (Must Pass)\n\n';
            comment += '| Scanner | Result |\n';
            comment += '|---------|--------|\n';
            comment += `| Trivy Secrets | ${{ steps.trivy_secrets.outcome }} |\n`;
            comment += `| Kubeconform | Passed |\n`;
            comment += `| Vault Policies | ${{ steps.vault_policies.outcome }} |\n`;
            comment += '\n### Security Scans\n\n';
            comment += '| Scanner | Result |\n';
            comment += '|---------|--------|\n`;
            comment += `| Trivy Misconfig | ${{ steps.trivy_misconfig.outcome }} |\n`;
            comment += `| Kubescape | ${{ steps.kubescape.outcome }} |\n`;
            comment += `| Checkov | ${{ steps.checkov.outcome }} |\n`;
            comment += `| Kube-score | ${{ steps.kube_score.outcome }} |\n`;
            comment += '\n---\n';
            comment += `View detailed results: [Security Tab](../security/code-scanning) | [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Final evaluation
        if: always()
        run: |
          echo "==================== FINAL SECURITY EVALUATION ===================="
          
          CRITICAL_FAILURES=0
          WARNINGS=0
          
          if [ "${{ steps.trivy_secrets.outcome }}" != "success" ]; then
            echo "CRITICAL: Trivy secrets scan failed"
            CRITICAL_FAILURES=$((CRITICAL_FAILURES + 1))
          fi
          
          if [ "${{ steps.vault_policies.outcome }}" != "success" ]; then
            echo "CRITICAL: Vault policy validation failed"
            CRITICAL_FAILURES=$((CRITICAL_FAILURES + 1))
          fi
          
          if [ "${{ steps.kubescape.outcome }}" == "failure" ]; then
            echo "WARNING: Kubescape found compliance issues"
            WARNINGS=$((WARNINGS + 1))
          fi
          
          if [ "${{ steps.checkov.outcome }}" == "failure" ]; then
            echo "WARNING: Checkov found policy violations"
            WARNINGS=$((WARNINGS + 1))
          fi
          
          if [ "${{ steps.trivy_misconfig.outcome }}" == "failure" ]; then
            echo "WARNING: Trivy misconfig found issues"
            WARNINGS=$((WARNINGS + 1))
          fi
          
          echo "=================================================================="
          echo "Critical Failures: $CRITICAL_FAILURES"
          echo "Warnings: $WARNINGS"
          echo "=================================================================="
          
          if [ $CRITICAL_FAILURES -gt 0 ]; then
            echo "::error::Pipeline failed due to $CRITICAL_FAILURES critical security issues"
            exit 1
          fi
          
          if [ $WARNINGS -gt 0 ]; then
            echo "::warning::Pipeline passed but has $WARNINGS security warnings to review"
          fi
          
          echo "Security validation complete - all critical checks passed"