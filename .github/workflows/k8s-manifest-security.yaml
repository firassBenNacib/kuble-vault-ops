name: K8s Manifests Security

on:
  push:
    branches: [ main, pipeline ]
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '!.github/**'
      - '.github/workflows/k8s-manifest-security.yaml'
  pull_request:
    branches: [ main, pipeline ]
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '!.github/**'
      - '.github/workflows/k8s-manifest-security.yaml'

env:
  MANIFEST_DIR: .
  TRIVY_VERSION: 'v0.68.1'
  KUBE_SCORE_VERSION: '1.18.0'
  VAULT_VERSION: '1.18.4'

jobs:
  k8s-manifest-security:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@v0.2.4
        with:
          version: ${{ env.TRIVY_VERSION }}
          cache: true

      - name: Trivy secret scan
        id: trivy_secrets
        run: |
          set +e
          trivy fs \
            --scanners secret \
            --skip-dirs .git --skip-dirs .github \
            --format sarif \
            --output trivy-secrets.sarif \
            --exit-code 1 \
            "${MANIFEST_DIR}"
          exit_code=$?
          set -e
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"

      - name: Upload Trivy secrets SARIF artifact
        if: ${{ always() && hashFiles('trivy-secrets.sarif') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: trivy-secrets-sarif-${{ github.run_number }}
          path: trivy-secrets.sarif
          retention-days: 90

      - name: Upload Trivy secrets SARIF to code scanning
        if: ${{ always() && hashFiles('trivy-secrets.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-secrets.sarif
          category: trivy-secrets

      - name: Trivy misconfig scan
        id: trivy_misconfig
        run: |
          set +e
          trivy fs \
            --scanners misconfig \
            --skip-dirs .git --skip-dirs .github \
            --format sarif \
            --output trivy-misconfig.sarif \
            --ignore-unfixed \
            --severity CRITICAL,HIGH \
            --exit-code 1 \
            "${MANIFEST_DIR}"
          exit_code=$?
          set -e
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"

      - name: Upload Trivy misconfig SARIF artifact
        if: ${{ always() && hashFiles('trivy-misconfig.sarif') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: trivy-misconfig-sarif-${{ github.run_number }}
          path: trivy-misconfig.sarif
          retention-days: 90

      - name: Upload Trivy misconfig SARIF to code scanning
        if: ${{ always() && hashFiles('trivy-misconfig.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-misconfig.sarif
          category: trivy-misconfig

      - name: Trivy IaC config scan
        id: trivy_config
        run: |
          set +e
          trivy config \
            --format sarif \
            --output trivy-config.sarif \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            "${MANIFEST_DIR}"
          exit_code=$?
          set -e
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"

      - name: Upload Trivy config SARIF artifact
        if: ${{ always() && hashFiles('trivy-config.sarif') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: trivy-config-sarif-${{ github.run_number }}
          path: trivy-config.sarif
          retention-days: 90

      - name: Upload Trivy config SARIF to code scanning
        if: ${{ always() && hashFiles('trivy-config.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-config.sarif
          category: trivy-config

      - name: Setup kubeconform
        uses: bmuschko/setup-kubeconform@v1.0.0

      - name: Run kubeconform validation
        id: kubeconform
        run: |
          set +e
          kubeconform \
            -summary \
            -strict \
            -ignore-missing-schemas \
            -output json \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/{{.NormalizedKubernetesVersion}}-standalone/{{.ResourceKind}}.json' \
            -ignore-filename-pattern '(^|/)vault/roles/' \
            -ignore-filename-pattern '(^|/)vault/policies/' \
            -ignore-filename-pattern '(^|/)vault/values/' \
            -ignore-filename-pattern '(^|/)\.github/' \
            -ignore-filename-pattern 'trivy-.*\.json$' \
            "${MANIFEST_DIR}" | tee kubeconform-results.json
          cmd_exit=$?
          set -e

          if command -v jq >/dev/null 2>&1; then
            invalid=$(jq '.summary.invalid // 0' kubeconform-results.json || echo 0)
          else
            echo "jq not found, assuming 0 invalid manifests"
            invalid=0
          fi

          exit_code=$cmd_exit
          if [ "$invalid" -gt 0 ]; then
            exit_code=1
          fi

          echo "invalid=$invalid"
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"

      - name: Upload kubeconform results
        if: ${{ always() && hashFiles('kubeconform-results.json') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: kubeconform-results-${{ github.run_number }}
          path: kubeconform-results.json
          retention-days: 30

      - name: Kubescape scan
        id: kubescape
        uses: kubescape/github-action@v3.0.21
        continue-on-error: true
        with:
          files: "**/*.yaml"
          format: sarif
          outputFile: kubescape-results.sarif
          severityThreshold: critical
          frameworks: |
            nsa,mitre,armobest

      - name: Upload Kubescape SARIF artifact
        if: ${{ always() && hashFiles('kubescape-results.sarif') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: kubescape-sarif-${{ github.run_number }}
          path: kubescape-results.sarif
          retention-days: 90

      - name: Upload Kubescape SARIF to code scanning
        if: ${{ always() && hashFiles('kubescape-results.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: kubescape-results.sarif
          category: kubescape

      - name: Install Vault CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip
          mkdir -p /tmp/vault-cli
          cd /tmp/vault-cli
          wget -q "https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip"
          wget -q "https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_SHA256SUMS" -O SHA256SUMS
          grep "vault_${VAULT_VERSION}_linux_amd64.zip" SHA256SUMS | sha256sum -c -
          unzip -o "vault_${VAULT_VERSION}_linux_amd64.zip"
          sudo mv vault /usr/local/bin/vault
          vault --version

      - name: Validate Vault policies
        id: vault_policies
        run: |
          set +e
          exit_code=0
          if [ -d vault/policies ]; then
            for policy in vault/policies/*.hcl; do
              if [ -f "$policy" ]; then
                echo "Validating $policy"
                vault policy fmt "$policy"
                rc=$?
                if [ "$rc" -ne 0 ]; then
                  exit_code=$rc
                fi
              fi
            done
          else
            echo "No vault/policies directory found, skipping Vault policy validation."
          fi
          set -e
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"

      - name: Run Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        continue-on-error: true
        with:
          directory: .
          framework: kubernetes
          output_format: sarif
          output_file_path: reports
          skip_framework: dockerfile

      - name: Upload Checkov SARIF artifact
        if: ${{ always() && hashFiles('reports/results.sarif') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: checkov-sarif-${{ github.run_number }}
          path: reports/results.sarif
          retention-days: 90

      - name: Upload Checkov SARIF to code scanning
        if: ${{ always() && hashFiles('reports/results.sarif') != '' }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/results.sarif
          category: checkov

      - name: Run kube-score
        id: kube_score
        run: |
          wget -q "https://github.com/zegl/kube-score/releases/download/v${KUBE_SCORE_VERSION}/checksums.txt" -O checksums.txt
          wget -q "https://github.com/zegl/kube-score/releases/download/v${KUBE_SCORE_VERSION}/kube-score_${KUBE_SCORE_VERSION}_linux_amd64" -O "kube-score_${KUBE_SCORE_VERSION}_linux_amd64"
          grep "kube-score_${KUBE_SCORE_VERSION}_linux_amd64$" checksums.txt | sha256sum -c -
          chmod +x "kube-score_${KUBE_SCORE_VERSION}_linux_amd64"
          mv "kube-score_${KUBE_SCORE_VERSION}_linux_amd64" kube-score
          set +e
          find "${MANIFEST_DIR}" -name '*.yaml' -print0 | xargs -0 ./kube-score score --output-format ci > kube-score-report.txt
          exit_code=$?
          set -e
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"

      - name: Upload kube-score report
        if: ${{ always() && hashFiles('kube-score-report.txt') != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: kube-score-report-${{ github.run_number }}
          path: kube-score-report.txt
          retention-days: 30

      - name: Evaluate scan results and fail if needed
        if: always()
        env:
          TRIVY_SECRETS_EXIT: ${{ steps.trivy_secrets.outputs.exit_code }}
          TRIVY_MISCONFIG_EXIT: ${{ steps.trivy_misconfig.outputs.exit_code }}
          TRIVY_CONFIG_EXIT: ${{ steps.trivy_config.outputs.exit_code }}
          KUBECONFORM_EXIT: ${{ steps.kubeconform.outputs.exit_code }}
          KUBESCAPE_OUTCOME: ${{ steps.kubescape.outcome }}
          CHECKOV_OUTCOME: ${{ steps.checkov.outcome }}
          KUBE_SCORE_EXIT: ${{ steps.kube_score.outputs.exit_code }}
          VAULT_EXIT: ${{ steps.vault_policies.outputs.exit_code }}
        run: |
          echo "Trivy secrets exit: ${TRIVY_SECRETS_EXIT:-0}"
          echo "Trivy misconfig exit: ${TRIVY_MISCONFIG_EXIT:-0}"
          echo "Trivy config exit: ${TRIVY_CONFIG_EXIT:-0}"
          echo "kubeconform exit: ${KUBECONFORM_EXIT:-0}"
          echo "Kubescape outcome: ${KUBESCAPE_OUTCOME:-unknown}"
          echo "Checkov outcome: ${CHECKOV_OUTCOME:-unknown}"
          echo "kube-score exit: ${KUBE_SCORE_EXIT:-0}"
          echo "Vault policies exit: ${VAULT_EXIT:-0}"

          failures=0

          if [ "${TRIVY_SECRETS_EXIT:-0}" -ne 0 ]; then failures=1; fi
          if [ "${TRIVY_MISCONFIG_EXIT:-0}" -ne 0 ]; then failures=1; fi
          if [ "${TRIVY_CONFIG_EXIT:-0}" -ne 0 ]; then failures=1; fi
          if [ "${KUBECONFORM_EXIT:-0}" -ne 0 ]; then failures=1; fi
          if [ "${VAULT_EXIT:-0}" -ne 0 ]; then failures=1; fi
          if [ "${KUBE_SCORE_EXIT:-0}" -ne 0 ]; then failures=1; fi

          if [ "${KUBESCAPE_OUTCOME}" = "failure" ]; then failures=1; fi
          if [ "${CHECKOV_OUTCOME}" = "failure" ]; then failures=1; fi

          if [ "$failures" -ne 0 ]; then
            echo "::error::One or more security scanners reported failures. See logs and SARIF artifacts for details."
            exit 1
          else
            echo "All security scanners passed configured policy thresholds."
          fi