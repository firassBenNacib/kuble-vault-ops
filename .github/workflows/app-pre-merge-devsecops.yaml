name: App Pre-merge DevSecOps

on:
  workflow_call:

env:
  IMAGE_TAG: ${{ github.sha }}
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  app-ci-devsecops:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      id-token: write

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK for backend
        if: hashFiles('pom.xml') != ''
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Set up Node.js for frontend
        if: hashFiles('package-lock.json') != ''
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Trunk Code Quality
        if: hashFiles('.trunk/trunk.yaml') != ''
        uses: trunk-io/trunk-action@v1.2.4

      - name: Maven build & tests for backend
        if: hashFiles('pom.xml') != ''
        run: mvn -B clean verify

      - name: npm install for frontend
        if: hashFiles('package-lock.json') != ''
        run: npm ci

      - name: npm tests for frontend
        if: hashFiles('package-lock.json') != ''
        run: npm test -- --watch=false || echo "Adjust test command if needed"

      - name: Angular production build for frontend
        if: hashFiles('angular.json') != ''
        run: npm run build -- --configuration=production

      - name: Install Semgrep
        run: pip install semgrep

      - name: Semgrep SAST
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        run: |
          if [ -n "$SEMGREP_APP_TOKEN" ]; then
            semgrep ci
          else
            semgrep scan --config p/ci
          fi

      - name: SonarQube analysis
        if: env.SONAR_TOKEN != '' && env.SONAR_HOST_URL != ''
        uses: SonarSource/sonarqube-scan-action@v1
        env:
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}

      - name: Install Trivy CLI
        run: |
          TRIVY_VERSION=0.68.1
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          tar zxvf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/trivy
          trivy --version

      - name: Trivy repo scan
        run: |
          trivy fs \
            --scanners vuln,misconfig,secret \
            --format table \
            --ignore-unfixed \
            --severity CRITICAL,HIGH \
            --exit-code 1 \
            .

      - name: Generate application SBOM CycloneDX
        run: |
          trivy fs \
            --scanners vuln \
            --format cyclonedx \
            --output app-sbom.cdx.json \
            --ignore-unfixed \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            .

      - name: Upload application SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-sbom
          path: app-sbom.cdx.json

      - name: Gitleaks secrets scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        if: hashFiles('pom.xml') != '' && hashFiles('Dockerfile') != ''
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/backend:${{ env.IMAGE_TAG }}
            ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest

      - name: Trivy scan backend image
        if: hashFiles('pom.xml') != '' && hashFiles('Dockerfile') != ''
        run: |
          trivy image \
            --ignore-unfixed \
            --severity CRITICAL,HIGH \
            --exit-code 1 \
            ${{ secrets.DOCKERHUB_USERNAME }}/backend:${{ env.IMAGE_TAG }}

      - name: Push backend image
        if: hashFiles('pom.xml') != '' && hashFiles('Dockerfile') != ''
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/backend:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/backend:latest

      - name: Sign backend image
        if: hashFiles('pom.xml') != '' && hashFiles('Dockerfile') != ''
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes \
            ${{ secrets.DOCKERHUB_USERNAME }}/backend:${{ env.IMAGE_TAG }}

      - name: Generate backend image SBOM CycloneDX
        if: hashFiles('pom.xml') != '' && hashFiles('Dockerfile') != ''
        run: |
          trivy image \
            --format cyclonedx \
            --output backend-image-sbom.cdx.json \
            --ignore-unfixed \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            ${{ secrets.DOCKERHUB_USERNAME }}/backend:${{ env.IMAGE_TAG }}

      - name: Upload backend image SBOM artifact
        if: hashFiles('pom.xml') != '' && hashFiles('Dockerfile') != ''
        uses: actions/upload-artifact@v4
        with:
          name: backend-image-sbom
          path: backend-image-sbom.cdx.json

      - name: Build frontend image
        if: hashFiles('angular.json') != '' && hashFiles('Dockerfile') != ''
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/frontend:${{ env.IMAGE_TAG }}
            ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest

      - name: Trivy scan frontend image
        if: hashFiles('angular.json') != '' && hashFiles('Dockerfile') != ''
        run: |
          trivy image \
            --ignore-unfixed \
            --severity CRITICAL,HIGH \
            --exit-code 1 \
            ${{ secrets.DOCKERHUB_USERNAME }}/frontend:${{ env.IMAGE_TAG }}

      - name: Push frontend image
        if: hashFiles('angular.json') != '' && hashFiles('Dockerfile') != ''
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/frontend:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest

      - name: Sign frontend image
        if: hashFiles('angular.json') != '' && hashFiles('Dockerfile') != ''
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes \
            ${{ secrets.DOCKERHUB_USERNAME }}/frontend:${{ env.IMAGE_TAG }}

      - name: Generate frontend image SBOM CycloneDX
        if: hashFiles('angular.json') != '' && hashFiles('Dockerfile') != ''
        run: |
          trivy image \
            --format cyclonedx \
            --output frontend-image-sbom.cdx.json \
            --ignore-unfixed \
            --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
            ${{ secrets.DOCKERHUB_USERNAME }}/frontend:${{ env.IMAGE_TAG }}

      - name: Upload frontend image SBOM artifact
        if: hashFiles('angular.json') != '' && hashFiles('Dockerfile') != ''
        uses: actions/upload-artifact@v4
        with:
          name: frontend-image-sbom
          path: frontend-image-sbom.cdx.json