name: App Pre-merge DevSecOps

on:
  workflow_call:
    inputs:
      enable_code_scanning:
        description: 'Enable upload-sarif steps (requires paid private repo or public repo)'
        required: false
        type: boolean
        default: false
      enable_owasp_dependency_check:
        description: 'Enable OWASP Dependency-Check (Java backend only)'
        required: false
        type: boolean
        default: false
      enable_trunk:
        description: 'Enable Trunk (optional)'
        required: false
        type: boolean
        default: false
      enable_sonarqube:
        description: 'Enable SonarQube (optional)'
        required: false
        type: boolean
        default: false
      enforce_policies:
        description: 'Fail workflow when policy thresholds are exceeded'
        required: false
        type: boolean
        default: true

env:
  TRIVY_VERSION: '0.68.2'
  SEMGREP_VERSION: '1.145.0'
  SYFT_VERSION: 'v1.38.2'
  LICENSE_CHECKER_VERSION: '25.0.1'
  DEPENDENCY_CHECK_VERSION: '12.1.9'
  DEPENDENCY_CHECK_DATA: ~/.dependency-check
  TRIVY_SEVERITY: 'CRITICAL,HIGH'
  NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
  IMAGE_TAG: ${{ github.sha }}
  BANNED_LICENSE_TOKENS: 'GPL-3.0,AGPL-3.0,LGPL-3.0'
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      has_backend: ${{ steps.detect.outputs.has_backend }}
      has_frontend: ${{ steps.detect.outputs.has_frontend }}
      backend_dir: ${{ steps.detect.outputs.backend_dir }}
      frontend_dir: ${{ steps.detect.outputs.frontend_dir }}
      build_backend_image: ${{ steps.detect.outputs.build_backend_image }}
      build_frontend_image: ${{ steps.detect.outputs.build_frontend_image }}
      build_any_image: ${{ steps.detect.outputs.build_any_image }}
      backend_image_context: ${{ steps.detect.outputs.backend_image_context }}
      backend_image_dockerfile: ${{ steps.detect.outputs.backend_image_dockerfile }}
      frontend_image_context: ${{ steps.detect.outputs.frontend_image_context }}
      frontend_image_dockerfile: ${{ steps.detect.outputs.frontend_image_dockerfile }}
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Detect project structure
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          has_backend=false
          backend_dir="."
          for d in "." "backend" "api" "server"; do
            if [ -f "$d/pom.xml" ] || [ -d "$d/src/main/java" ]; then
              has_backend=true
              backend_dir="$d"
              break
            fi
          done

          has_frontend=false
          frontend_dir="."
          for d in "." "frontend" "client" "web" "ui"; do
            if [ -f "$d/package-lock.json" ] || [ -f "$d/package.json" ] || [ -d "$d/src/app" ]; then
              has_frontend=true
              frontend_dir="$d"
              break
            fi
          done

          build_backend_image=false
          backend_image_context=""
          backend_image_dockerfile=""

          if [ "$has_backend" = "true" ]; then
            if [ -f "$backend_dir/Dockerfile" ]; then
              build_backend_image=true
              backend_image_context="$backend_dir"
              backend_image_dockerfile="Dockerfile"
            elif [ -f "Dockerfile.backend" ]; then
              build_backend_image=true
              backend_image_context="."
              backend_image_dockerfile="Dockerfile.backend"
            elif [ -f "Dockerfile" ] && [ "$has_frontend" = "false" ]; then
              build_backend_image=true
              backend_image_context="."
              backend_image_dockerfile="Dockerfile"
            fi
          fi

          build_frontend_image=false
          frontend_image_context=""
          frontend_image_dockerfile=""

          if [ "$has_frontend" = "true" ]; then
            if [ -f "$frontend_dir/Dockerfile" ]; then
              build_frontend_image=true
              frontend_image_context="$frontend_dir"
              frontend_image_dockerfile="Dockerfile"
            elif [ -f "Dockerfile.frontend" ]; then
              build_frontend_image=true
              frontend_image_context="."
              frontend_image_dockerfile="Dockerfile.frontend"
            elif [ -f "Dockerfile" ] && [ "$has_backend" = "false" ]; then
              build_frontend_image=true
              frontend_image_context="."
              frontend_image_dockerfile="Dockerfile"
            fi
          fi

          build_any_image=false
          if [ "$build_backend_image" = "true" ] || [ "$build_frontend_image" = "true" ]; then
            build_any_image=true
          fi

          {
            echo "has_backend=$has_backend"
            echo "backend_dir=$backend_dir"
            echo "has_frontend=$has_frontend"
            echo "frontend_dir=$frontend_dir"

            echo "build_backend_image=$build_backend_image"
            echo "backend_image_context=$backend_image_context"
            echo "backend_image_dockerfile=$backend_image_dockerfile"

            echo "build_frontend_image=$build_frontend_image"
            echo "frontend_image_context=$frontend_image_context"
            echo "frontend_image_dockerfile=$frontend_image_dockerfile"

            echo "build_any_image=$build_any_image"
          } >> "$GITHUB_OUTPUT"

  code-quality-and-sast:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    needs: [detect]
    permissions:
      contents: read
      security-events: write
      checks: write
      actions: read
      pull-requests: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Trunk Code Quality
        if: hashFiles('.trunk/trunk.yaml') != ''
        uses: trunk-io/trunk-action@75699af9e26881e564e9d832ef7dc3af25ec031b # v1.2.4
        continue-on-error: true

      - name: Set up JDK (backend)
        if: needs.detect.outputs.has_backend == 'true'
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Set up Node.js (frontend)
        if: needs.detect.outputs.has_frontend == 'true'
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: |
            **/package-lock.json

      - name: Maven build and tests
        if: needs.detect.outputs.has_backend == 'true'
        working-directory: ${{ needs.detect.outputs.backend_dir }}
        run: mvn -B -ntp clean verify -DskipTests=false
        env:
          MAVEN_OPTS: "-Xmx2048m"

      - name: Verify Maven dependency signatures
        if: needs.detect.outputs.has_backend == 'true'
        working-directory: ${{ needs.detect.outputs.backend_dir }}
        run: |
          mvn -B dependency:purge-local-repository clean verify \
            -DcheckSignature=true \
            -DskipTests=true
        continue-on-error: true

      - name: Cache OWASP Dependency-Check data
        if: inputs.enable_owasp_dependency_check && needs.detect.outputs.has_backend == 'true'
        id: depcheck_cache
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.DEPENDENCY_CHECK_DATA }}
          key: depcheck-${{ runner.os }}-${{ env.DEPENDENCY_CHECK_VERSION }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            depcheck-${{ runner.os }}-${{ env.DEPENDENCY_CHECK_VERSION }}-

      - name: Maven dependency check
        if: inputs.enable_owasp_dependency_check && needs.detect.outputs.has_backend == 'true'
        id: depcheck
        working-directory: ${{ needs.detect.outputs.backend_dir }}
        run: |
          set +e
          mkdir -p "${DEPENDENCY_CHECK_DATA}"

          AUTO_UPDATE=true
          if [ "${{ steps.depcheck_cache.outputs.cache-hit }}" = "true" ] && [ -f "${DEPENDENCY_CHECK_DATA}/odc.mv.db" ]; then
            CACHE_AGE_SECONDS=$(($(date +%s) - $(stat -c %Y "${DEPENDENCY_CHECK_DATA}/odc.mv.db")))
            CACHE_AGE_HOURS=$((CACHE_AGE_SECONDS / 3600))
            if [ $CACHE_AGE_HOURS -lt 24 ]; then
              echo "Cache is recent (${CACHE_AGE_HOURS} hours old), skipping auto-update"
              AUTO_UPDATE=false
            fi
          fi

          EXTRA_NVD=""
          if [ -n "${NVD_API_KEY}" ]; then
            EXTRA_NVD="-DnvdApiKey=${NVD_API_KEY}"
          fi

          SUPPRESS_ARG=""
          if [ -f "dependency-check-suppressions.xml" ]; then
            SUPPRESS_ARG="-DsuppressionFiles=dependency-check-suppressions.xml"
          fi

          mvn -B -ntp org.owasp:dependency-check-maven:${DEPENDENCY_CHECK_VERSION}:check \
            -DfailBuildOnCVSS=7 \
            -DdataDirectory="${DEPENDENCY_CHECK_DATA}" \
            -DautoUpdate="${AUTO_UPDATE}" \
            -Dformats=HTML,JSON,SARIF \
            ${SUPPRESS_ARG} \
            ${EXTRA_NVD}

          exit_code=$?
          set -e
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: npm install
        if: needs.detect.outputs.has_frontend == 'true'
        working-directory: ${{ needs.detect.outputs.frontend_dir }}
        run: npm ci --prefer-offline --no-audit

      - name: npm audit (gate on parsed JSON)
        if: needs.detect.outputs.has_frontend == 'true'
        id: npm_audit
        working-directory: ${{ needs.detect.outputs.frontend_dir }}
        run: |
          set -euo pipefail
          npm audit --audit-level=high --json > npm-audit.json || true

          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          data=json.load(open("npm-audit.json"))
          vul=data.get("metadata",{}).get("vulnerabilities",{})
          high=int(vul.get("high",0) or 0)
          critical=int(vul.get("critical",0) or 0)
          print(f"high={high}")
          print(f"critical={critical}")
          print(f"high_critical_total={high+critical}")
          PY

      - name: npm tests (skip if script missing)
        if: needs.detect.outputs.has_frontend == 'true'
        id: npm_tests
        working-directory: ${{ needs.detect.outputs.frontend_dir }}
        run: |
          set +e
          npm run test:ci --if-present 2>&1 | tee npm-test.log
          exit_code=${PIPESTATUS[0]}
          set -e
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Frontend production build (Angular if present, else generic)
        if: needs.detect.outputs.has_frontend == 'true'
        working-directory: ${{ needs.detect.outputs.frontend_dir }}
        run: |
          set -e
          if [ -f "angular.json" ]; then
            npm run build -- --configuration=production
          else
            npm run build --if-present
          fi

      - name: Check npm artifacts exist
        if: needs.detect.outputs.has_frontend == 'true'
        id: npm_artifacts
        run: |
          set -euo pipefail
          audit_exists=false
          test_exists=false

          if [ "${{ needs.detect.outputs.has_frontend }}" = "true" ]; then
            if [ -f "${{ needs.detect.outputs.frontend_dir }}/npm-audit.json" ]; then audit_exists=true; fi
            if [ -f "${{ needs.detect.outputs.frontend_dir }}/npm-test.log" ]; then test_exists=true; fi
          fi

          echo "audit_exists=$audit_exists" >> "$GITHUB_OUTPUT"
          echo "test_exists=$test_exists" >> "$GITHUB_OUTPUT"

      - name: Upload npm audit results
        if: steps.npm_artifacts.outputs.audit_exists == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: npm-audit-${{ github.run_number }}
          path: ${{ needs.detect.outputs.frontend_dir }}/npm-audit.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload npm test log
        if: steps.npm_artifacts.outputs.test_exists == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: npm-test-log-${{ github.run_number }}
          path: ${{ needs.detect.outputs.frontend_dir }}/npm-test.log
          retention-days: 30
          if-no-files-found: ignore

      - name: Check dependency-check reports exist
        if: always()
        id: depcheck_reports
        run: |
          set -euo pipefail
          exists=false
          if [ "${{ needs.detect.outputs.has_backend }}" = "true" ]; then
            base="${{ needs.detect.outputs.backend_dir }}"
            for f in \
              "$base/target/dependency-check-report.html" \
              "$base/target/dependency-check-report.json" \
              "$base/target/dependency-check-report.sarif"
            do
              if [ -f "$f" ]; then exists=true; fi
            done
          fi
          echo "exists=$exists" >> "$GITHUB_OUTPUT"

      - name: Upload dependency-check reports
        if: steps.depcheck_reports.outputs.exists == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: dependency-check-${{ github.run_number }}
          path: |
            ${{ needs.detect.outputs.backend_dir }}/target/dependency-check-report.html
            ${{ needs.detect.outputs.backend_dir }}/target/dependency-check-report.json
            ${{ needs.detect.outputs.backend_dir }}/target/dependency-check-report.sarif
          retention-days: 90
          if-no-files-found: ignore

      - name: Install Semgrep
        run: |
          python3 -m pip install --no-cache-dir --upgrade pip
          python3 -m pip install --no-cache-dir semgrep==${{ env.SEMGREP_VERSION }}
          semgrep --version

      - name: Semgrep SAST (gate only on SARIF level=error)
        id: semgrep
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        run: |
          set +e
          if [ -n "${SEMGREP_APP_TOKEN:-}" ]; then
            semgrep ci --sarif --output semgrep.sarif
          else
            semgrep scan --config p/ci --sarif --output semgrep.sarif
          fi
          tool_exit=$?
          set -e
          echo "tool_exit=$tool_exit" >> "$GITHUB_OUTPUT"

          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json, os
          if not os.path.exists("semgrep.sarif"):
            print("sarif_exists=false"); print("error_count=0"); raise SystemExit(0)
          d=json.load(open("semgrep.sarif"))
          results=[]
          for run in d.get("runs",[]):
            results += run.get("results",[]) or []
          err=sum(1 for r in results if (r.get("level") or "").lower()=="error")
          print("sarif_exists=true")
          print(f"error_count={err}")
          PY
        continue-on-error: true

      - name: Upload Semgrep SARIF artifact
        if: steps.semgrep.outputs.sarif_exists == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: semgrep-sarif-${{ github.run_number }}
          path: semgrep.sarif
          retention-days: 90
          if-no-files-found: ignore

      - name: Upload Semgrep SARIF to code scanning
        if: inputs.enable_code_scanning == true && steps.semgrep.outputs.sarif_exists == 'true'
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: semgrep.sarif
          category: semgrep
        continue-on-error: true

      - name: SonarQube analysis
        if: inputs.enable_sonarqube && env.SONAR_TOKEN != '' && env.SONAR_HOST_URL != ''
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        env:
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        continue-on-error: true

      - name: SonarQube Quality Gate
        if: inputs.enable_sonarqube && env.SONAR_TOKEN != '' && env.SONAR_HOST_URL != ''
        uses: sonarsource/sonarqube-quality-gate-action@cf038b0e0cdecfa9e56c198bbb7d21d751d62c3b # v1.2.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
        continue-on-error: true

      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1 # v0.2.4
        with:
          version: v${{ env.TRIVY_VERSION }}
          cache: true

      - name: Trivy filesystem scan (table in logs + SARIF for upload)
        id: trivy_fs
        run: |
          set -euo pipefail

          echo "== Trivy FS (table output) =="
          trivy fs \
            --scanners vuln,misconfig \
            --severity "${TRIVY_SEVERITY}" \
            --exit-code 0 \
            --no-progress \
            --format table \
            .

          echo "== Trivy FS (SARIF output) =="
          trivy fs \
            --scanners vuln,misconfig \
            --severity "${TRIVY_SEVERITY}" \
            --exit-code 0 \
            --no-progress \
            --format sarif \
            --output trivy-fs.sarif \
            .

          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json, os
          d=json.load(open("trivy-fs.sarif")) if os.path.exists("trivy-fs.sarif") else {"runs":[]}
          count=sum(len(r.get("results",[]) or []) for r in d.get("runs",[]))
          print("sarif_exists=true" if os.path.exists("trivy-fs.sarif") else "sarif_exists=false")
          print(f"result_count={count}")
          PY
        continue-on-error: true

      - name: Upload Trivy filesystem SARIF artifact
        if: steps.trivy_fs.outputs.sarif_exists == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: trivy-fs-sarif-${{ github.run_number }}
          path: trivy-fs.sarif
          retention-days: 90
          if-no-files-found: ignore

      - name: Upload Trivy filesystem SARIF to code scanning
        if: inputs.enable_code_scanning == true && steps.trivy_fs.outputs.sarif_exists == 'true'
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: trivy-fs.sarif
          category: trivy-filesystem
        continue-on-error: true

      - name: Upload OWASP SARIF to code scanning
        if: inputs.enable_owasp_dependency_check && inputs.enable_code_scanning && steps.depcheck_reports.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: ${{ needs.detect.outputs.backend_dir }}/target/dependency-check-report.sarif
          category: owasp-dependency-check
        continue-on-error: true

      - name: Evaluate quality and SAST
        if: always() && inputs.enforce_policies
        env:
          DEPCHECK_EXIT: ${{ steps.depcheck.outputs.exit_code }}
          NPM_TESTS_EXIT: ${{ steps.npm_tests.outputs.exit_code }}
          NPM_AUDIT_HC: ${{ steps.npm_audit.outputs.high_critical_total }}
          SEMGREP_TOOL_EXIT: ${{ steps.semgrep.outputs.tool_exit }}
          SEMGREP_ERRORS: ${{ steps.semgrep.outputs.error_count }}
          TRIVY_FS_COUNT: ${{ steps.trivy_fs.outputs.result_count }}
          HAS_BACKEND: ${{ needs.detect.outputs.has_backend }}
          HAS_FRONTEND: ${{ needs.detect.outputs.has_frontend }}
        run: |
          failures=0

          if [ "${HAS_FRONTEND}" = "true" ] && [ "${NPM_TESTS_EXIT:-0}" -ne 0 ]; then
            echo "::error::NPM tests failed"
            failures=1
          fi

          if [ "${HAS_BACKEND}" = "true" ] && [ "${DEPCHECK_EXIT:-0}" -ne 0 ]; then
            echo "::warning::Dependency check reported vulnerabilities (CVSS >= 7) or execution error"
            failures=1
          fi

          if [ "${HAS_FRONTEND}" = "true" ] && [ "${NPM_AUDIT_HC:-0}" -ne 0 ]; then
            echo "::warning::NPM audit found high/critical vulnerabilities (high+critical=${NPM_AUDIT_HC})"
            failures=1
          fi

          if [ "${SEMGREP_TOOL_EXIT:-0}" -gt 1 ]; then
            echo "::error::Semgrep execution failed (exit=${SEMGREP_TOOL_EXIT})"
            failures=1
          fi
          if [ "${SEMGREP_ERRORS:-0}" -ne 0 ]; then
            echo "::warning::Semgrep reported error-level findings (count=${SEMGREP_ERRORS})"
            failures=1
          fi

          if [ "${TRIVY_FS_COUNT:-0}" -ne 0 ]; then
            echo "::error::Trivy filesystem scan found CRITICAL/HIGH issues (count=${TRIVY_FS_COUNT})"
            failures=1
          fi

          if [ "$failures" -ne 0 ]; then
            echo "::error::One or more quality/SAST checks failed policy."
            exit 1
          fi

  secrets-and-filesystem-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [detect]
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1 # v0.2.4
        with:
          version: v${{ env.TRIVY_VERSION }}
          cache: true

      - name: Gitleaks secrets scan
        id: gitleaks
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7 # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: TruffleHog secrets scan
        id: trufflehog
        run: |
          echo "Current branch: ${{ github.ref_name }}"
          echo "Event type: ${{ github.event_name }}"

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "== PR detected: Scanning git changes from ${{ github.base_ref }} to ${{ github.head_ref }} =="
            docker run --rm -v "$(pwd):/workdir" ghcr.io/trufflesecurity/trufflehog:3.92.3 \
              git file:///workdir \
              --only-verified \
              --base "${{ github.base_ref }}" \
              --head HEAD 2>&1 | tail -20 || true
          else
            echo "== Not a PR: Scanning filesystem (current state) =="
            docker run --rm -v "$(pwd):/workdir" ghcr.io/trufflesecurity/trufflehog:3.92.3 \
              filesystem /workdir \
              --only-verified 2>&1 | tail -20 || true
          fi
        continue-on-error: true

      - name: Trivy secret scan (filesystem)
        id: trivy_secrets
        run: |
          echo "== Trivy Secret Scan =="
          trivy fs --scanners secret \
            --format table \
            --exit-code 0 \
            --no-progress \
            .

          trivy fs --scanners secret \
            --format sarif \
            --output trivy-secrets.sarif \
            --exit-code 0 \
            --no-progress \
            .

          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json, os
          d=json.load(open("trivy-secrets.sarif")) if os.path.exists("trivy-secrets.sarif") else {"runs":[]}
          count=sum(len(r.get("results",[]) or []) for r in d.get("runs",[]))
          print("sarif_exists=true" if os.path.exists("trivy-secrets.sarif") else "sarif_exists=false")
          print(f"secret_count={count}")
          PY
        continue-on-error: true

      - name: Upload Gitleaks SARIF to code scanning
        if: inputs.enable_code_scanning && hashFiles('gitleaks.sarif') != ''
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: gitleaks.sarif
          category: gitleaks
        continue-on-error: true

      - name: Upload Trivy secrets SARIF to code scanning
        if: inputs.enable_code_scanning && hashFiles('trivy-secrets.sarif') != ''
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: trivy-secrets.sarif
          category: trivy-secrets
        continue-on-error: true

      - name: Evaluate secrets and filesystem scan
        if: always() && inputs.enforce_policies
        env:
          GITLEAKS_OUTCOME: ${{ steps.gitleaks.outcome }}
          TRUVY_SECRET_COUNT: ${{ steps.trivy_secrets.outputs.secret_count }}
        run: |
          failures=0

          if [ "${GITLEAKS_OUTCOME}" != "success" ]; then
            echo "::error::Gitleaks found secrets or failed"
            failures=1
          fi

          if [ "${TRUVY_SECRET_COUNT:-0}" -ne 0 ]; then
            echo "::error::Trivy found secrets in filesystem (count=${TRUVY_SECRET_COUNT})"
            failures=1
          fi

          if [ "$failures" -ne 0 ]; then
            echo "::error::Secrets/filesystem scanning failed policy."
            exit 1
          fi

  container-image-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [detect]
    permissions:
      contents: read
      security-events: write
      actions: read
      pull-requests: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@e6c2c5e321ed9123bda567646e2f96565e34abe1 # v0.2.4
        with:
          version: v${{ env.TRIVY_VERSION }}
          cache: true

      - name: Set up QEMU
        if: needs.detect.outputs.build_any_image == 'true'
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Set up Docker Buildx
        if: needs.detect.outputs.build_any_image == 'true'
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Build backend image
        if: needs.detect.outputs.build_backend_image == 'true'
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ${{ needs.detect.outputs.backend_image_context }}
          file: ${{ needs.detect.outputs.backend_image_context }}/${{ needs.detect.outputs.backend_image_dockerfile }}
          push: false
          load: true
          tags: local/backend:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        if: needs.detect.outputs.build_frontend_image == 'true'
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ${{ needs.detect.outputs.frontend_image_context }}
          file: ${{ needs.detect.outputs.frontend_image_context }}/${{ needs.detect.outputs.frontend_image_dockerfile }}
          push: false
          load: true
          tags: local/frontend:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install Syft
        if: needs.detect.outputs.build_any_image == 'true'
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/${{ env.SYFT_VERSION }}/install.sh | sh -s -- -b /usr/local/bin ${{ env.SYFT_VERSION }}
          syft version

      - name: Generate backend SBOM
        if: needs.detect.outputs.build_backend_image == 'true'
        run: |
          syft local/backend:${{ env.IMAGE_TAG }} \
            -o cyclonedx-json=backend-sbom.cdx.json \
            -o spdx-json=backend-sbom.spdx.json

      - name: Generate frontend SBOM
        if: needs.detect.outputs.build_frontend_image == 'true'
        run: |
          syft local/frontend:${{ env.IMAGE_TAG }} \
            -o cyclonedx-json=frontend-sbom.cdx.json \
            -o spdx-json=frontend-sbom.spdx.json

      - name: Validate SBOM quality
        if: needs.detect.outputs.build_any_image == 'true'
        run: |
          echo "Validating generated SBOMs..."
          validate_sbom() {
            local sbom_file=$1
            if [[ ! -f "$sbom_file" ]]; then
              echo "SBOM file not found: $sbom_file"
              return 0
            fi
            echo "Checking $sbom_file"

            if ! jq -e '.metadata and .components' "$sbom_file" > /dev/null 2>&1; then
              echo "ERROR: $sbom_file is missing required top-level structure (metadata, components)."
              exit 1
            fi
            
            COMPONENT_COUNT=$(jq '.components | length' "$sbom_file")
            if [ "$COMPONENT_COUNT" -eq 0 ]; then
              echo "WARNING: $sbom_file contains zero components. It may be empty."
            else
              echo "SUCCESS: $sbom_file is valid and contains $COMPONENT_COUNT components."
            fi
          }
          
          if [ "${{ needs.detect.outputs.build_backend_image }}" = "true" ] && [ -f "backend-sbom.cdx.json" ]; then
            validate_sbom "backend-sbom.cdx.json"
          fi
          
          if [ "${{ needs.detect.outputs.build_frontend_image }}" = "true" ] && [ -f "frontend-sbom.cdx.json" ]; then
            validate_sbom "frontend-sbom.cdx.json"
          fi
        continue-on-error: true

      - name: Upload SBOMs
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: pre-merge-sboms-${{ github.run_number }}
          path: |
            *-sbom.cdx.json
            *-sbom.spdx.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Trivy scan backend image (table + SARIF)
        if: needs.detect.outputs.build_backend_image == 'true'
        id: trivy_backend_image
        run: |
          set -euo pipefail

          echo "== Trivy image (backend) - table output =="
          trivy image \
            --severity "${TRIVY_SEVERITY}" \
            --exit-code 0 \
            --no-progress \
            --format table \
            local/backend:${{ env.IMAGE_TAG }}

          echo "== Trivy image (backend) - SARIF output =="
          trivy image \
            --severity "${TRIVY_SEVERITY}" \
            --exit-code 0 \
            --no-progress \
            --format sarif \
            --output trivy-backend-image.sarif \
            local/backend:${{ env.IMAGE_TAG }}

          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json, os
          d=json.load(open("trivy-backend-image.sarif")) if os.path.exists("trivy-backend-image.sarif") else {"runs":[]}
          count=sum(len(r.get("results",[]) or []) for r in d.get("runs",[]))
          print("sarif_exists=true" if os.path.exists("trivy-backend-image.sarif") else "sarif_exists=false")
          print(f"result_count={count}")
          PY
        continue-on-error: true

      - name: Trivy scan frontend image (table + SARIF)
        if: needs.detect.outputs.build_frontend_image == 'true'
        id: trivy_frontend_image
        run: |
          set -euo pipefail

          echo "== Trivy image (frontend) - table output =="
          trivy image \
            --severity "${TRIVY_SEVERITY}" \
            --exit-code 0 \
            --no-progress \
            --format table \
            local/frontend:${{ env.IMAGE_TAG }}

          echo "== Trivy image (frontend) - SARIF output =="
          trivy image \
            --severity "${TRIVY_SEVERITY}" \
            --exit-code 0 \
            --no-progress \
            --format sarif \
            --output trivy-frontend-image.sarif \
            local/frontend:${{ env.IMAGE_TAG }}

          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json, os
          d=json.load(open("trivy-frontend-image.sarif")) if os.path.exists("trivy-frontend-image.sarif") else {"runs":[]}
          count=sum(len(r.get("results",[]) or []) for r in d.get("runs",[]))
          print("sarif_exists=true" if os.path.exists("trivy-frontend-image.sarif") else "sarif_exists=false")
          print(f"result_count={count}")
          PY
        continue-on-error: true

      - name: Upload Trivy backend image SARIF artifact
        if: steps.trivy_backend_image.outputs.sarif_exists == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: trivy-backend-image-sarif-${{ github.run_number }}
          path: trivy-backend-image.sarif
          retention-days: 90
          if-no-files-found: ignore

      - name: Upload Trivy frontend image SARIF artifact
        if: steps.trivy_frontend_image.outputs.sarif_exists == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: trivy-frontend-image-sarif-${{ github.run_number }}
          path: trivy-frontend-image.sarif
          retention-days: 90
          if-no-files-found: ignore

      - name: Upload Trivy backend image SARIF to code scanning
        if: inputs.enable_code_scanning == true && steps.trivy_backend_image.outputs.sarif_exists == 'true'
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: trivy-backend-image.sarif
          category: trivy-backend-image
        continue-on-error: true

      - name: Upload Trivy frontend image SARIF to code scanning
        if: inputs.enable_code_scanning == true && steps.trivy_frontend_image.outputs.sarif_exists == 'true'
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: trivy-frontend-image.sarif
          category: trivy-frontend-image
        continue-on-error: true

      - name: Evaluate image scans
        if: always() && inputs.enforce_policies
        env:
          BUILD_BACKEND: ${{ needs.detect.outputs.build_backend_image }}
          BUILD_FRONTEND: ${{ needs.detect.outputs.build_frontend_image }}
          BACKEND_COUNT: ${{ steps.trivy_backend_image.outputs.result_count }}
          FRONTEND_COUNT: ${{ steps.trivy_frontend_image.outputs.result_count }}
        run: |
          failures=0

          if [ "${BUILD_BACKEND}" = "true" ] && [ "${BACKEND_COUNT:-0}" -ne 0 ]; then
            echo "::error::Backend image scan found critical/high vulnerabilities (count=${BACKEND_COUNT})"
            failures=1
          fi

          if [ "${BUILD_FRONTEND}" = "true" ] && [ "${FRONTEND_COUNT:-0}" -ne 0 ]; then
            echo "::error::Frontend image scan found critical/high vulnerabilities (count=${FRONTEND_COUNT})"
            failures=1
          fi

          if [ "$failures" -ne 0 ]; then
            echo "::error::Container image scanning failed policy."
            exit 1
          fi

  license-compliance:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect]
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up JDK (backend)
        if: needs.detect.outputs.has_backend == 'true'
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Set up Node.js (frontend)
        if: needs.detect.outputs.has_frontend == 'true'
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: |
            **/package-lock.json

      - name: Maven license check
        if: needs.detect.outputs.has_backend == 'true'
        id: maven_license
        working-directory: ${{ needs.detect.outputs.backend_dir }}
        run: |
          set +e
          exit_code=0
          banned_found=false

          mvn -B -ntp license:license-list -Dlicense.skipDownloadLicenses=true -Dlicense.jsonOutputFile=target/licenses.json

          if [ -f "target/licenses.json" ]; then
            echo "Checking licenses.json for banned licenses..."
            python3 - <<'PY'
            import json, sys, os
            
            banned_tokens = os.environ.get("BANNED_LICENSE_TOKENS", "").split(",")
            banned_tokens = [t.strip() for t in banned_tokens if t.strip()]
            
            try:
              with open("target/licenses.json", "r") as f:
                data = json.load(f)
              
              for dep in data.get("dependencies", []):
                licenses = dep.get("licenses", [])
                for license_info in licenses:
                  license_name = license_info.get("name", "")
                  for banned in banned_tokens:
                    if banned.lower() in license_name.lower():
                      print(f"::error::Banned license '{banned}' found in: {dep.get('artifactId')}")
                      sys.exit(1)
            except Exception as e:
              print(f"::warning::Could not parse licenses.json: {e}")
              sys.exit(0)
            PY
            exit_code=$?
            if [ $exit_code -ne 0 ]; then
              banned_found=true
            fi
          else
            echo "::warning::Could not generate license file. Network restrictions may be blocking downloads."
          fi

          set -e
          echo "banned_found=$banned_found" >> "$GITHUB_OUTPUT"
          echo "exit_code=$exit_code" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: npm license report + strict SPDX token enforcement
        if: needs.detect.outputs.has_frontend == 'true'
        id: npm_license
        working-directory: ${{ needs.detect.outputs.frontend_dir }}
        run: |
          set -euo pipefail
          npm install -g license-checker@${{ env.LICENSE_CHECKER_VERSION }}
          npm ci --prefer-offline --no-audit
          license-checker --json --out licenses.json

          python3 - <<'PY'
          import json, os

          banned=os.environ.get("BANNED_LICENSE_TOKENS","").split(",")
          banned=[b.strip() for b in banned if b.strip()]

          data=json.load(open("licenses.json", encoding="utf-8"))
          bad=[]
          for pkg, info in data.items():
            lic=info.get("licenses","")
            s=";".join(lic) if isinstance(lic,list) else str(lic)
            if any(tok in s for tok in banned):
              bad.append((pkg,s))

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"banned_count={len(bad)}\n")

          if bad:
            print("First offenders:")
            for pkg,s in bad[:50]:
              print(f"- {pkg}: {s}")
          PY

      - name: Upload license reports
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: license-reports-${{ github.run_number }}
          path: |
            ${{ needs.detect.outputs.backend_dir }}/target/licenses/
            ${{ needs.detect.outputs.backend_dir }}/target/dependency-tree.txt
            ${{ needs.detect.outputs.frontend_dir }}/licenses.json
          retention-days: 90
          if-no-files-found: ignore

      - name: Evaluate license compliance
        if: always() && inputs.enforce_policies
        env:
          MAVEN_BANNED: ${{ steps.maven_license.outputs.banned_found }}
          NPM_BANNED_COUNT: ${{ steps.npm_license.outputs.banned_count }}
        run: |
          failures=0

          if [ "${MAVEN_BANNED}" = "true" ]; then
            echo "::error::Maven dependencies contain banned license tokens (${BANNED_LICENSE_TOKENS})"
            failures=1
          fi

          if [ "${NPM_BANNED_COUNT:-0}" -ne 0 ]; then
            echo "::error::NPM dependencies contain banned license tokens (${BANNED_LICENSE_TOKENS}); count=${NPM_BANNED_COUNT}"
            failures=1
          fi

          if [ "$failures" -ne 0 ]; then
            echo "::error::License compliance check failed."
            exit 1
          fi

  supply-chain-security:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [detect]
    if: github.ref_name == 'main' || github.event_name == 'pull_request'
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Run OpenSSF Scorecard
        if: github.ref_name == 'main'
        uses: ossf/scorecard-action@4eaacf0543bb3f2c246792bd56e8cdeffafb205a # v2.4.3
        with:
          results_file: scorecard.sarif
          results_format: sarif
          publish_results: false
        continue-on-error: true

      - name: Upload Scorecard SARIF to code scanning
        if: inputs.enable_code_scanning && hashFiles('scorecard.sarif') != ''
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: scorecard.sarif
          category: scorecard
        continue-on-error: true

      - name: Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          fail-on-severity: high
        continue-on-error: true

  security-summary:
    runs-on: ubuntu-latest
    needs: [detect, code-quality-and-sast, secrets-and-filesystem-scan, container-image-scan, license-compliance, supply-chain-security]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Generate security summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<'EOF'
          # Application Security Scan Results (Pre-merge)

          ## Detected Components
          - Backend present: ${{ needs.detect.outputs.has_backend }}
          - Frontend present: ${{ needs.detect.outputs.has_frontend }}
          - Backend image build enabled: ${{ needs.detect.outputs.build_backend_image }}
          - Frontend image build enabled: ${{ needs.detect.outputs.build_frontend_image }}

          ## Job Status
          | Job | Status |
          |-----|--------|
          | Code Quality & SAST | ${{ needs.code-quality-and-sast.result }} |
          | Secrets & Filesystem Scan | ${{ needs.secrets-and-filesystem-scan.result }} |
          | Container Image Scan | ${{ needs.container-image-scan.result }} |
          | License Compliance | ${{ needs.license-compliance.result }} |
          | Supply Chain Security | ${{ needs.supply-chain-security.result }} |

          ## Security Policies Enforced
          - Secrets scanning (Gitleaks, TruffleHog, Trivy)
          - SAST analysis (Semgrep)
          - Dependency vulnerabilities (OWASP if enabled, npm audit, Trivy FS)
          - Container image vulnerabilities (Trivy)
          - License compliance (token-based)
          - Filesystem misconfigurations + vuln (Trivy FS)
          - Code quality (Trunk if enabled, SonarQube if enabled)
          EOF

      - name: Check critical failures
        if: inputs.enforce_policies
        run: |
          failures=0

          if [ "${{ needs.secrets-and-filesystem-scan.result }}" != "success" ]; then
            echo "::error::Secrets/filesystem scan failed"
            failures=1
          fi

          if [ "${{ needs.container-image-scan.result }}" != "success" ] && [ "${{ needs.container-image-scan.result }}" != "skipped" ]; then
            echo "::error::Container image scan failed"
            failures=1
          fi

          if [ "${{ needs.code-quality-and-sast.result }}" != "success" ]; then
            echo "::error::Code quality/SAST checks failed"
            failures=1
          fi

          if [ "${{ needs.license-compliance.result }}" != "success" ]; then
            echo "::error::License compliance check failed"
            failures=1
          fi

          if [ "$failures" -ne 0 ]; then
            echo "::error::Pre-merge DevSecOps validation failed."
            exit 1
          fi