name: K8s Manifests Security

on:
  push:
    branches: [ main, pipeline ]
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '!.github/**'
      - '.github/workflows/k8s-manifest-security.yml'
  pull_request:
    branches: [ main, pipeline ]
    paths:
      - '**/*.yaml'
      - '**/*.yml'
      - '!.github/**'
      - '.github/workflows/k8s-manifest-security.yml'

env:
  MANIFEST_DIR: .

jobs:
  k8s-manifest-security:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Trivy CLI
        run: |
          TRIVY_VERSION=0.68.1
          wget -q https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          tar zxvf trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz
          sudo mv trivy /usr/local/bin/trivy
          trivy --version

      - name: Trivy secret scan
        run: |
          trivy fs \
            --scanners secret \
            --skip-dirs .git --skip-dirs .github \
            --format sarif \
            --output trivy-secrets.sarif \
            --exit-code 1 \
            "${MANIFEST_DIR}"
        continue-on-error: false

      - name: Trivy misconfig scan
        run: |
          trivy fs \
            --scanners misconfig \
            --skip-dirs .git --skip-dirs .github \
            --format sarif \
            --output trivy-misconfig.sarif \
            --ignore-unfixed \
            --severity CRITICAL,HIGH \
            --exit-code 1 \
            "${MANIFEST_DIR}"
        continue-on-error: false

      - name: Trivy IaC config scan
        run: |
          trivy config \
            --format sarif \
            --output trivy-config.sarif \
            --severity CRITICAL,HIGH \
            --exit-code 0 \
            "${MANIFEST_DIR}"
        continue-on-error: true

      - name: Upload Trivy secrets SARIF to code scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-secrets.sarif
          category: trivy-secrets

      - name: Upload Trivy misconfig SARIF to code scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-misconfig.sarif
          category: trivy-misconfig

      - name: Upload Trivy config SARIF to code scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-config.sarif
          category: trivy-config

      - name: Generate SBOM in CycloneDX format
        if: always()
        run: |
          trivy fs \
            --scanners vuln \
            --format cyclonedx \
            --output trivy-sbom-k8s.cdx.json \
            "${MANIFEST_DIR}"

      - name: Upload Trivy SBOM artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sbom-k8s-${{ github.run_number }}
          path: trivy-sbom-k8s.cdx.json
          retention-days: 90

      - name: Setup kubeconform
        uses: bmuschko/setup-kubeconform@v1.0.0

      - name: Run kubeconform validation
        run: |
          kubeconform \
            -summary \
            -strict \
            -ignore-missing-schemas \
            -output json \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/{{.NormalizedKubernetesVersion}}-standalone/{{.ResourceKind}}.json' \
            -ignore-filename-pattern '(^|/)vault/roles/' \
            -ignore-filename-pattern '(^|/)vault/policies/' \
            -ignore-filename-pattern '(^|/)vault/values/' \
            -ignore-filename-pattern '(^|/)\.github/' \
            -ignore-filename-pattern 'trivy-.*\.json$' \
            "${MANIFEST_DIR}" | tee kubeconform-results.json

          ERRORS=$(jq '.summary.invalid' kubeconform-results.json)
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::Kubeconform found $ERRORS invalid manifests"
            exit 1
          fi

      - name: Upload kubeconform results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kubeconform-results-${{ github.run_number }}
          path: kubeconform-results.json
          retention-days: 30

      - name: Kubescape scan
        uses: kubescape/github-action@v3.0.21
        continue-on-error: false
        with:
          files: "**/*.yaml"
          format: sarif
          outputFile: kubescape-results.sarif
          severityThreshold: critical
          frameworks: |
            nsa,mitre,armobest

      - name: Upload Kubescape SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kubescape-sarif-${{ github.run_number }}
          path: kubescape-results.sarif
          retention-days: 90

      - name: Upload Kubescape SARIF to code scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: kubescape-results.sarif
          category: kubescape

      - name: Install Vault CLI
        run: |
          VAULT_VERSION=1.18.4
          sudo apt-get update -y
          sudo apt-get install -y unzip
          mkdir -p /tmp/vault-cli
          cd /tmp/vault-cli
          wget -q https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip
          unzip -o vault_${VAULT_VERSION}_linux_amd64.zip
          sudo mv vault /usr/local/bin/vault
          vault --version

      - name: Validate Vault policies
        run: |
          if [ -d vault/policies ]; then
            for policy in vault/policies/*.hcl; do
              if [ -f "$policy" ]; then
                echo "Validating $policy"
                vault policy fmt "$policy"
              fi
            done
          else
            echo "No vault/policies directory found, skipping Vault policy validation."
          fi
        continue-on-error: false

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: kubernetes
          output_format: sarif
          output_file_path: reports
          skip_framework: dockerfile

      - name: Upload Checkov SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-sarif-${{ github.run_number }}
          path: reports/results.sarif
          retention-days: 90

      - name: Upload Checkov SARIF to code scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: reports/results.sarif
          category: checkov

      - name: Run kube-score
        run: |
          wget https://github.com/zegl/kube-score/releases/download/v1.18.0/kube-score_1.18.0_linux_amd64 -O kube-score
          chmod +x kube-score
          find "${MANIFEST_DIR}" -name '*.yaml' -print0 | xargs -0 ./kube-score score --output-format ci
